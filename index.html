<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>A simple map</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <script src='nouislider.js'></script>
    
    <link rel="stylesheet" href="nouislider.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">

    <style>
        body {margin: 0; padding: 0;}
/*        #button {position: absolute; top: 0; left: 0; margin: 140px 0px 0px 130px; z-index: 1000}*/
        #map {width: 100%;}
/*        #date {position: absolute; top: 0; left: 0; margin: 240px 0px 0px 130px; z-index: 1000}*/
        #overlay {
            position: absolute;
            z-index: 1000;
            background: rgba(237, 215, 192,0.5);
            padding: 10px;
            bottom: 0;
            left: 0;
            margin: 10px;
            border-radius: 10px;
            box-shadow: 1px 1px 1px black;
            min-height: 200px;
            min-width: 400px;
        }

    </style>
</head>

<body>
    <div id ="map"></div>
    <div id = "overlay">
        <h2> Date Toggle </h2>
        <div id = "button">
            <button id = 'preveous_day'> Day-1 </button>
            <button id = 'next_day'> Day+1 </button>
        </div>
        <div id = "date">
            <p>Date: <input type="text" id="datebox"></p>
        </div>
        <div id = "slider"></div>
    </div>
    
    <script>
        $(document).ready(function() {
            
            $('#map').height(window.innerHeight);
                        
            var tx_counties = "https://raw.githubusercontent.com/TNRIS/tx.geojson/master/counties/tx_counties.geojson";
            var us_boarder = "https://raw.githubusercontent.com/mp0530/OPS/ff2f3670d923b9a49763a4ba19c5fb23de617ff4/test.geojson"
            var map = L.map('map', {zoomControl: false})
                .setView([30.266, -97.73], 6);

            var basemap = L.tileLayer('http://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="http://cartodb.com/attributions">CartoDB</a>',
                subdomains: 'abcd',
                maxZoom: 19
            }).addTo(map);
            L.marker([30.467589, -97.680010]).bindPopup("My Home!").addTo(map);

            
///////////////////////////////// Transferring CSV to Object!//////////////////////////////////////////
            
            console.log('Transffering CSV to Object...');
            var table = {};
            
            // Load data
            var data = $.ajax({
                type: "GET",
                url: "texas.csv",
                dataType: "text",
                success: function(data) {
                    processData(data);
                    geotolayer();}
                });
            
            // Modify data
            function processData(data) {
                var lines = data.split(/\r\n|\n/);
                for (var i = 0; i < lines.length; i++) {
                    var arr = lines[i].split(',');
                    table[arr[0]] = arr.slice(1,);
                };
                len = table["Anderson"].length;
                // console.log(len);
            };
            
            // JSON call create Geojson Layer after data successfully modified
            function geotolayer() {
                console.log('Geojson to Layer...');
                var counties = $.ajax({
                    url: tx_counties,
                    dataType: "json",
                    success: function(counties) {procces_counties(counties);},
                    error: function(xhr) {alert("Bad")}
                });
            };
            
            // Create Geojson, append to map
            var texas_county
            function procces_counties(counties) {
                texas_county = L.geoJSON(counties,{
                    style: texas_style,
                    onEachFeature: function (feature, layer) {
                        layer.bindTooltip(feature.properties.COUNTY + ": " + table[feature.properties.COUNTY.slice(0,-7)][len-1]);
                    }
                }).addTo(map);
            };
            
/////////////////////////////////////////// Update Date ////////////////////////////////////////////////
            
            function date_changed(e) { 
                // (e --> timestamp)
                e = new Date(e);
                console.log(e);
                $("#datebox").val((e.getMonth()+1).toString() + "/" + (e.getDate()).toString() + "/" + (e.getFullYear()).toString());
                texas_county.setStyle(function(feature) {return texas_style(feature, Math.floor((e - first_date)/(1000 * 3600 * 24)))});
            }
            
////////////////////////////////// Update style when date change ///////////////////////////////////////
            
            // Style when date modified
            function texas_style(feature, index) {
                return {
                    fillColor: county_color(table[feature.properties.COUNTY.slice(0,-7)][index]),
                    weight: 2,
                    opacity: 1,
                    color: 'white',
                    dashArray: '3',
                    fillOpacity: 0.7
                };
            };
            
            // Pick a color
            function county_color(n) {
                return  n != parseInt(n, 10) ? "#FDFEFE"  : 
                        n < 10 ? "#f7fcf5" :
                        n < 20 ? "#e5f5e0" :
                        n < 50 ? "#c7e9c0" :
                        n < 100 ? "#a1d99b":
                        n < 200 ? "#74c476":
                        n < 500 ? "#41ab5d":
                        n < 1000 ? "#238b45":
                        n < 5000 ? "#006d2c":
                        "#00441b"
            };
//////////////////////////////////// Update tooltip when date change //////////////////////////////////////
            
/////////////////////////////////////////////// date-picker ///////////////////////////////////////////////
            
            var today = new Date();
            var first_date = new Date("03/04/2020");
            document.getElementById('datebox').value = (today.getMonth()+1).toString() + "/" + today.getDate().toString() + "/" + today.getFullYear().toString();

            $('#datebox').datepicker().on("change", function(t) {
                t = new Date(t.target.value);
                console.log(t);
                slider.noUiSlider.set(t.getTime());
                texas_county.setStyle(function(feature) {return texas_style(feature, Math.floor((t.getTime() - first_date)/(1000 * 3600 * 24)))});
            });

////////////////////////////////////////////////// button /////////////////////////////////////////////////
            
            $(document).on('click', '#preveous_day', function() {
                box_date = new Date(document.getElementById('datebox').value);
                slider.noUiSlider.set(box_date.getTime() - 86400000);
                return date_changed(box_date.getTime() - 86400000);
            });
            $(document).on('click', '#next_day', function() {
                box_date = new Date(document.getElementById('datebox').value);
                slider.noUiSlider.set(box_date.getTime() + 86400000);
                return date_changed(box_date.getTime() + 86400000);
            });
            
////////////////////////////////////////////////// slider /////////////////////////////////////////////////
            
            var slider = document.getElementById('slider');
            function timestamp(str) {return new Date(str).getTime();}
            
            noUiSlider.create(slider, {
                start: today,
                step: 24 * 60 * 60 * 1000,
                pips: {mode: "values", values: [first_date.getTime(), today.getTime()], density: 24 * 60 * 60 * 1000},
                range: {'min': timestamp("2020"), 'max': timestamp("2021")},
            }).on("slide", function(e) {
                return date_changed(parseInt(e[0]));

            });
            slider.noUiSlider.on("change", function(e) {
                if (e < first_date.getTime()) {
                    slider.noUiSlider.set(first_date.getTime());
                } else if (e > today.getTime()) {
                    slider.noUiSlider.set(today.getTime());
                };
            });
            
///////////////////////////////////////////////////////////////////////////////////////////////////////////
            
        }); // Document border


    </script>

</body>

</html>
