<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>A simple map</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <script src='nouislider.js'></script>
    
    <link rel="stylesheet" href="nouislider.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">

    <style>
        body {margin: 0; padding: 0;}
/*        #button {position: absolute; top: 0; left: 0; margin: 140px 0px 0px 130px; z-index: 1000}*/
        #map {width: 100%;}
/*        #date {position: absolute; top: 0; left: 0; margin: 240px 0px 0px 130px; z-index: 1000}*/
        #overlay {
            position: absolute;
            z-index: 1000;
            background: rgba(237, 215, 192,0.5);
            padding: 10px;
            bottom: 0;
            left: 0;
            margin: 10px;
            border-radius: 10px;
            box-shadow: 1px 1px 1px black;
            min-height: 200px;
            min-width: 400px;
        }
        #remove {position: absolute; top: 10px; right: 10px;}


    </style>
</head>

<body>
    <div id ="map"></div>
    <div id = "overlay">
        <h3 id = "title"> Texas Covid-19 Cases by County </h3>
        <div id = "button">
            <button id = 'preveous_day'> Day-1 </button>
            <button id = 'next_day'> Day+1 </button>
            <div id = 'remove'>
                <p><button id = 'sick'> Cases </button></p>
                <p><button id = 'fatality'> Fatalities</button></p>
            </div>
        </div>
        <div id = "date">
            <p>Date: <input type="text" id="datebox"></p>
        </div>
        <div id = "slider"></div>
    </div>
    
    <script>
        $(document).ready(function() {
            
            $('#map').height(window.innerHeight);
//            var us_boarder = "https://raw.githubusercontent.com/mp0530/OPS/ff2f3670d923b9a49763a4ba19c5fb23de617ff4/test.geojson"
            var map = L.map('map', {zoomControl: false})
                .setView([30.266, -97.73], 5);

            var basemap = L.tileLayer('http://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="http://cartodb.com/attributions">CartoDB</a>',
                subdomains: 'abcd',
                maxZoom: 19
            }).addTo(map);
//            L.marker([30.467589, -97.680010]).bindPopup("My Home!").addTo(map);

            
///////////////////////////////// Transferring CSV to Object!//////////////////////////////////////////
            
            console.log('Transffering CSV to Object...');
            var tx_table;
            var tx_table_fatality;
            
            ///////////////////////// Load sick data ///////////////////////////////
            $.ajax({
                type: "GET",
                url: "texas_cases.csv",
                dataType: "text",
                success: function(data) {
                    tx_table = tx_processData(data);
                    geotolayer(tx_table);}
                });
            // Modify data
            function tx_processData(data) {
                let table = {}
                let lines = data.split(/\r\n|\n/);
                for (var i = 0; i < lines.length; i++) {
                    var arr = lines[i].split(',');
                    table[arr[0]] = arr.slice(1,);
                };
                return table
            }; 
            
            // JSON call create Geojson Layer after data successfully modified
            function geotolayer(table) {
                console.log('Geojson to Layer...');
                tx_counties = $.ajax({
                    url: "https://raw.githubusercontent.com/TNRIS/tx.geojson/master/counties/tx_counties.geojson",
                    dataType: "json",
                    success: function(tx_counties) {procces_counties(tx_counties);},
                    error: function(xhr) {alert("Bad")}
                });
            };
            
            // Create Geojson, append to map
            var tx_cases_layer
            function procces_counties(counties) {
                tx_cases_layer = L.geoJSON(counties,{
                    style: function(feature) {
                        return texas_style(feature, Math.floor((today.getTime() - first_date.getTime())/(1000 * 3600 * 24)));
                    },
                    onEachFeature: function(feature, layer) {
                        layer.bindTooltip(feature.properties.COUNTY + ": " + tx_table[feature.properties.COUNTY.slice(0,-7)][Math.floor((today.getTime() - first_date.getTime())/(1000 * 3600 * 24))])
                    }
                }).addTo(map);
            };
            $.ajax({
                type: "GET",
                url: "texas_fatality.csv",
                dataType: "text",
                success: function(data) {
                    console.log("fatality success");
                    tx_table_fatality = tx_processData(data);
                    $.ajax({
                        url: "https://raw.githubusercontent.com/TNRIS/tx.geojson/master/counties/tx_counties.geojson",
                        dataType: "json",
                        success: function(tx_counties) {
                            tx_fatalities_layer = L.geoJSON(tx_counties, {
                                style: texas_style,
                                onEachFeature: function(feature, layer) {
                                    layer.bindTooltip(feature.properties.COUNTY + ": " + tx_table_fatality[(feature.properties.COUNTY.slice(0,-7)).toUpperCase()][Math.floor((today.getTime() - first_date.getTime())/(1000 * 3600 * 24))])
                                }
                            })
                        }
                    })
                }
            });
            

/////////////////////////////////////////// Update Date ////////////////////////////////////////////////
            
            function date_changed(e) { 
                // (e --> timestamp)
                e = new Date(e);
//                console.log(e);
                $("#datebox").val((e.getMonth()+1).toString() + "/" + (e.getDate()).toString() + "/" + (e.getFullYear()).toString());
                if (cases) {
                    tx_cases_layer.setStyle(function(feature) {return texas_style(feature, Math.floor((e - first_date.getTime())/(1000 * 3600 * 24)))});
                } else {
                    tx_fatalities_layer.setStyle(function(feature) {return texas_style(feature, Math.floor((e - first_date.getTime())/(1000 * 3600 * 24)))});
                }
            }
            
////////////////////////////////// Update style when date change ///////////////////////////////////////
            
            // Style when date modified
            function texas_style(feature, index) {
                if (cases) {
                    return {
                        fillColor: cases_color(tx_table[feature.properties.COUNTY.slice(0,-7)][index]),
                        weight: 2,
                        opacity: 1,
                        color: 'white',
                        dashArray: '3',
                        fillOpacity: 0.7
                    };                    
                } else {
                    return {
                        fillColor: fatalities_color(tx_table_fatality[(feature.properties.COUNTY.slice(0,-7)).toUpperCase()][index]),
                        weight: 2,
                        opacity: 1,
                        color: 'white',
                        dashArray: '3',
                        fillOpacity: 0.7
                    }
                }
            };
            
            // Cases color
            function cases_color(n) {
                return  n != parseInt(n, 10) ? "#FDFEFE"  : 
                        n < 10 ? "#f7fcf5" :
                        n < 20 ? "#e5f5e0" :
                        n < 50 ? "#c7e9c0" :
                        n < 100 ? "#a1d99b":
                        n < 200 ? "#74c476":
                        n < 500 ? "#41ab5d":
                        n < 1000 ? "#238b45":
                        n < 5000 ? "#006d2c":
                        "#00441b"
            };
            
            // Fatalities color
            function fatalities_color(n) {
                return  n != parseInt(n, 10) ? "#FDFEFE":
                        n < 5 ? "#fff5f0" :
                        n < 10 ? "#fee0d2":
                        n < 20 ? "#fcbba1":
                        n < 50 ? "#fc9272":
                        n < 100? "#fb6a4a":
                        n < 250? "#ef3b2c":
                        n < 500? "#cb181d":
                        n < 1000?"#99000d":
                        "#67000d"
            }
//////////////////////////////////// Update tooltip when date change //////////////////////////////////////
            
            function texas_tooltip(e) {
                if (cases) {
                    tx_cases_layer.eachLayer(function(feature) {
                        feature.setTooltipContent(feature.feature.properties.COUNTY + ": " + tx_table[feature.feature.properties.COUNTY.slice(0,-7)][Math.floor((e - first_date)/(1000 * 3600 * 24))])
                    })    
                } else {
                    tx_fatalities_layer.eachLayer(function(feature) {
                        feature.setTooltipContent(feature.feature.properties.COUNTY + ": " + tx_table_fatality[(feature.feature.properties.COUNTY.slice(0,-7)).toUpperCase()][Math.floor((e - first_date)/(1000 * 3600 * 24))])
                    })
                }
            };
            
/////////////////////////////////////////////// date-picker ///////////////////////////////////////////////
            
            var today = new Date("10/15/2020");
            var first_date = new Date("03/04/2020");
            document.getElementById('datebox').value = (today.getMonth()+1).toString() + "/" + today.getDate().toString() + "/" + today.getFullYear().toString();

            $('#datebox').datepicker().on("change", function(t) {
                t = new Date(t.target.value);
                console.log(t);
                slider.noUiSlider.set(t.getTime());
                if (cases) {
                    tx_cases_layer.setStyle(function(feature) {return texas_style(feature, Math.floor((t.getTime() - first_date)/(1000 * 3600 * 24)))});
                } else {
                    tx_fatalities_layer.setStyle(function(feature) {return texas_style(feature, Math.floor((t.getTime() - first_date)/(1000 * 3600 * 24)))})
                };
                texas_tooltip(t.getTime());
            });

////////////////////////////////////////////////// button /////////////////////////////////////////////////
            
            $(document).on('click', '#preveous_day', function() {
                box_date = new Date(document.getElementById('datebox').value);
                box_date.setDate(box_date.getDate()-1);
                slider.noUiSlider.set(box_date.getTime());
                texas_tooltip(box_date.getTime());
                return date_changed(box_date.getTime());
            });
            $(document).on('click', '#next_day', function() {
                box_date = new Date(document.getElementById('datebox').value);
                box_date.setDate(box_date.getDate()+1);
                slider.noUiSlider.set(box_date.getTime());
                texas_tooltip(box_date.getTime());
                return date_changed(box_date.getTime());
            });
            
            var cases = true;
            console.log(cases);
            $(document).on('click', '#sick', function() {
                console.log('To sick...');
                if (cases == false) {
                    cases = true;
                    $("#title").text("Texas Covid-19 Cases by County");
                    console.log(false);
                    map.removeLayer(tx_fatalities_layer);
                    tx_cases_layer.addTo(map);
                    box_date = new Date(document.getElementById('datebox').value);
                    texas_tooltip(box_date.getTime());
                    date_changed(box_date.getTime());
                    
                };
            });
            $(document).on('click', '#fatality', function() {
                console.log('To fatality....');
                if (cases == true) {
                    cases = false;
                    $("#title").text("Texas Covid-19 Fatalities by County");
                    map.removeLayer(tx_cases_layer);
                    tx_fatalities_layer.addTo(map);
                    box_date = new Date(document.getElementById('datebox').value);
                    texas_tooltip(box_date.getTime());
                    date_changed(box_date.getTime());
                }
            })
////////////////////////////////////////////////// slider /////////////////////////////////////////////////
            
            var slider = document.getElementById('slider');
            function timestamp(str) {return new Date(str).getTime();}
            
            noUiSlider.create(slider, {
                start: today,
                step: 24 * 60 * 60 * 1000,
//                pips: {mode: "values", values: [first_date.getTime(), today.getTime()], density: 24 * 60 * 60 * 1000},
                range: {'min': timestamp("2020"), 'max': timestamp("2021")},
            }).on("slide", function(e) {
                return date_changed(parseInt(e[0]));

            });
            slider.noUiSlider.on("change", function(e) {
                if (e < first_date.getTime()) {
                    slider.noUiSlider.set(first_date.getTime());
                    e = first_date.getTime();
                    date_changed(e);
                } else if (e > today.getTime()) {
                    slider.noUiSlider.set(today.getTime());
                    e = today.getTime();
                    date_changed(e);
                };
                texas_tooltip(e);
            });
            
///////////////////////////////////////////////////////////////////////////////////////////////////////////
            
        }); // Document border


    </script>

</body>

</html>
